<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.deloitte.bdh.data.collation.dao.bi.BiEtlSyncPlanMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.deloitte.bdh.data.collation.model.BiEtlSyncPlan">
        <id column="id" property="id"/>
        <result column="CODE" property="code"/>
        <result column="GROUP_CODE" property="groupCode"/>
        <result column="PLAN_TYPE" property="planType"/>
        <result column="REF_MODEL_CODE" property="refModelCode"/>
        <result column="REF_MAPPING_CODE" property="refMappingCode"/>
        <result column="IS_FIRST" property="isFirst"/>
        <result column="PLAN_STAGE" property="planStage"/>
        <result column="PLAN_RESULT" property="planResult"/>
        <result column="RESULT_DESC" property="resultDesc"/>
        <result column="PROCESS_COUNT" property="processCount"/>
        <result column="PLAN_SQL" property="planSql"/>
        <result column="SQL_COUNT" property="sqlCount"/>
        <result column="SQL_LOCAL_COUNT" property="sqlLocalCount"/>
        <result column="CREATE_DATE" property="createDate"/>
        <result column="CREATE_USER" property="createUser"/>
        <result column="MODIFIED_DATE" property="modifiedDate"/>
        <result column="MODIFIED_USER" property="modifiedUser"/>
        <result column="IP" property="ip"/>
        <result column="TENANT_ID" property="tenantId"/>
    </resultMap>

    <resultMap id="SyncPlanResultMap" type="com.deloitte.bdh.data.collation.model.BiEtlSyncPlanResult">
        <result column="ID" property="id"/>
        <result column="CODE" property="code"/>
        <result column="PLAN_NAME" property="name"/>
        <result column="GROUP_CODE" property="groupCode"/>
        <result column="PLAN_TYPE" property="planType"/>
        <result column="PLAN_STAGE" property="planStage"/>
        <result column="PLAN_RESULT" property="planResult"/>
        <result column="RESULT_DESC" property="resultDesc"/>
        <result column="SQL_COUNT" property="sqlCount"/>
        <result column="SQL_LOCAL_COUNT" property="sqlLocalCount"/>
        <result column="CREATE_DATE" property="createDate"/>
        <result column="MODIFIED_DATE" property="modifiedDate"/>
        <result column="MODEL_CODE" property="modelCode"/>
        <result column="MODEL_NAME" property="modelName"/>
        <result column="MODEL_CRON_EXPRESSION" property="modelCronExpression"/>
        <result column="MODEL_CREATE_DATE" property="modelCreateDate"/>
        <result column="MODEL_MODIFIED_DATE" property="modelModifiedDate"/>
    </resultMap>

    <select id="selectPlanList" resultMap="SyncPlanResultMap" parameterType="com.deloitte.bdh.data.collation.model.request.BiEtlSyncPlanListDto">
        SELECT
            t1.ID,
            t1.CODE,
            t1.GROUP_CODE,
            t1.PLAN_TYPE,
            t1.PLAN_STAGE,
            t1.PLAN_RESULT,
            t1.RESULT_DESC,
            t1.SQL_COUNT,
            t1.SQL_LOCAL_COUNT,
            t1.CREATE_DATE,
            t1.MODIFIED_DATE,
            t1.REF_MODEL_CODE MODEL_CODE,
            t2.NAME MODEL_NAME,
            t2.CRON_EXPRESSION MODEL_CRON_EXPRESSION,
            t2.CREATE_DATE MODEL_CREATE_DATE,
            t2.MODIFIED_DATE MODEL_MODIFIED_DATE,
            CASE WHEN t4.NAME IS NULL THEN t2.NAME ELSE t4.NAME END AS PLAN_NAME
        FROM
            BI_ETL_SYNC_PLAN t1
            LEFT JOIN BI_ETL_MODEL t2 ON t1.REF_MODEL_CODE = t2.CODE
            LEFT JOIN BI_ETL_MAPPING_CONFIG t3 ON t1.REF_MAPPING_CODE = t3.CODE
            LEFT JOIN BI_COMPONENT t4 ON t3.REF_COMPONENT_CODE = t4.CODE
        <where>
            <if test="modelCode != null and modelCode != ''">
                AND t1.REF_MODEL_CODE = #{modelCode}
            </if>
            <if test="modelName != null and modelName != ''">
                AND t2.NAME LIKE CONCAT(CONCAT("%", #{modelName}), "%")
            </if>
            <if test="planType != null and planType != ''">
                AND t1.PLAN_TYPE = #{planType}
            </if>
            <if test="planResult != null and planResult != ''">
                AND t1.PLAN_TYPE = #{planResult}
            </if>
        </where>
    </select>

</mapper>
